<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGIP Eligibility & Incentive Calculator</title>
  <style>
    :root {
      --primary: #f7941d;
      --secondary: #0070c0;
      --dark: #05334f;
      --light: #f9f9f9;
      --text: #111;
      --error: #c00;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: var(--light);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: #fff;
      padding: 1.25rem 1rem;
      text-align: center;
    }
    header h1 { margin: 0; font-size: clamp(1.5rem, 5vw, 2.25rem); }

    main {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
      flex: 1;
    }

    section {
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.25rem 1.5rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 4px 10px rgba(0,0,0,.05);
    }
    section h2 { margin-top: 0; color: var(--dark); }

    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.6rem 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    .help {
      font-size: 0.87rem;
      color: var(--secondary);
    }

    .grid {
      display: grid;
      gap: 1rem;
    }
    @media (min-width:640px) { .grid-2 { grid-template-columns: 1fr 1fr; } }

    button {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: transform .15s ease, background .3s ease;
    }
    button:hover { background: #d67e12; transform: translateY(-2px); }
    button:active { transform: translateY(0); }

    .error { color: var(--error); font-size: 0.9rem; }

    /* Results */
    .results-card {
      display: none;
      animation: fade .4s ease-in-out;
    }
    .results-card.show { display: block; }
    @keyframes fade { from{opacity:0; transform:translateY(12px);} to{opacity:1; transform:translateY(0);} }

    .badge {
      display: inline-block;
      background: var(--secondary);
      color:#fff;
      padding:0.25rem 0.6rem;
      border-radius: 4px;
      font-size:.78rem;
      margin-bottom:.5rem;
    }

    table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    th, td { padding: 0.6rem; border-bottom: 1px solid #ddd; text-align: left; }
    th { background: var(--light); }

    iframe { width:100%; border:none; border-radius:8px; margin-top:1rem; }

    footer {
      font-size: .8rem;
      text-align: center;
      padding: 1rem 0 2rem;
    }

    @media (prefers-reduced-motion: reduce) { * { transition: none !important; } }
  </style>
</head>
<body>
  <header>
    <h1>California SGIP Eligibility & Incentive Calculator</h1>
  </header>
  <main>
    <form id="calcForm">
      <!-- Customer & Utility -->
      <section>
        <h2>1. Customer Information</h2>
        <div class="grid grid-2">
          <label>Utility (IOU)
            <select id="utility" aria-label="Utility" required>
              <option value="">Choose…</option>
              <option>PG&amp;E</option>
              <option>SCE</option>
              <option>SDG&amp;E</option>
              <option>SoCalGas</option>
              <option>LADWP</option>
            </select>
          </label>
          <label>Customer Type
            <select id="custType" aria-label="Customer type" required>
              <option value="">Choose…</option>
              <option>Single-Family</option>
              <option>Multifamily</option>
              <option>Non-Residential</option>
            </select>
          </label>
        </div>
      </section>

      <!-- Location & Community -->
      <section>
        <h2>2. Location &amp; Community</h2>
        <div class="grid grid-2">
          <label>ZIP Code
            <input id="zip" type="text" pattern="\\d{5}" inputmode="numeric" placeholder="e.g. 90001" required />
          </label>
          <label>In Disadvantaged Comm. (DAC) or HFTD?
            <select id="dacHftd" required>
              <option value="">Choose…</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>SJV Pilot Community?
            <select id="sjvTown" required>
              <option value="">Choose…</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
        </div>
        <p class="help">Use map below if unsure whether you’re in a DAC.</p>
        <iframe title="Disadvantaged Community Map" src="https://experience.arcgis.com/experience/1c21c53da8de48f1b946f3402fbae55c/page/SB-535-Disadvantaged-Communities?embed=true" height="400" loading="lazy"></iframe>
      </section>

      <!-- Income & Flags -->
      <section>
        <h2>3. Income &amp; Resiliency Flags</h2>
        <div class="grid grid-2">
          <label>Household ≤ 80% AMI / CARE / FERA?
            <select id="incomeFlag" required>
              <option value="">Choose…</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>PSPS, medical baseline or well‑pump?
            <select id="pspsFlag" required>
              <option value="">Choose…</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
          <label>Critical Facility Type
            <select id="criticalFacility" required>
              <option value="none">None</option>
              <option>Hospital</option>
              <option>Fire Station</option>
              <option>Police Station</option>
              <option>Water / Wastewater</option>
              <option>Telecom</option>
            </select>
          </label>
        </div>
      </section>

      <!-- System -->
      <section>
        <h2>4. System Sizing</h2>
        <div class="grid grid-2">
          <label>Storage Size (kWh)
            <input id="storageKWh" type="number" min="0" step="0.1" value="30.6" required />
          </label>
          <label>Paired Solar Size (kW)
            <input id="solarKW" type="number" min="0" step="0.1" value="8" />
          </label>
          <label>Backup‑capable?
            <select id="backupCapable" required>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </label>
        </div>
        <p id="error" class="error" aria-live="polite"></p>
        <button type="submit" aria-label="Calculate incentives">Calculate</button>
      </section>
    </form>

    <section id="results" class="results-card" aria-label="Results"></section>
  </main>

  <footer>
    Rates per <a href="https://www.cpuc.ca.gov/sgip" target="_blank" rel="noopener">CPUC SGIP</a>. Unofficial tool.
  </footer>

  <script>
    const RATES = {
      resSolarStorageEquity2025: 1.10, // $/Wh (1100 $/kWh)
      solarAdder: 3.10,                // $/W
      resStorageEquity: 0.85,          // $/Wh (legacy)
      resEquityResiliency: 1.00,       // $/Wh
      smallResStep1: 0.50,             // $/Wh
      largeScaleStorageStep1: 0.50,    // $/Wh
      resiliencyAdderNonRes: 0.15,     // $/Wh
      genBase: 2.00,                   // $/W
      genResiliencyAdder: 2.50         // $/W
    };

    const programs = [
      {
        name: "Residential Solar & Storage Equity (Low‑Income)",
        badge: "Res Equity Solar+Storage",
        category: "residential",
        eligibility: u => (u.custType !== "Non-Residential") && (u.incomeFlag === "yes"),
        rate: u => RATES.resSolarStorageEquity2025,
        caps: { kWh: () => 30 } // cap is 30 kWh unless justified
      },
      {
        name: "Residential Equity (Storage‑only)",
        badge: "Res Equity Storage",
        category: "residential",
        eligibility: u => (u.custType !== "Non-Residential") && (u.incomeFlag === "yes"),
        rate: u => RATES.resStorageEquity,
        caps: { kWh: () => 30 }
      },
      {
        name: "Residential Equity – Resiliency",
        badge: "Equity‑Resiliency",
        category: "residential",
        eligibility: u => (u.custType !== "Non-Residential") && (u.pspsFlag === "yes"),
        rate: u => RATES.resEquityResiliency,
        caps: { kWh: () => 30 }
      },
      {
        name: "Small Residential Storage (General Market)",
        badge: "Small Res",
        category: "residential",
        eligibility: u => (u.custType !== "Non-Residential"),
        rate: u => RATES.smallResStep1,
        caps: { kWh: () => 30 }
      },
      {
        name: "San Joaquin Valley Pilot",
        badge: "SJV Pilot",
        category: "residential",
        eligibility: u => u.sjvTown === "yes",
        rate: u => RATES.resSolarStorageEquity2025,
        caps: { kWh: () => 30 }
      },
      {
        name: "Non‑Residential Equity",
        badge: "Non‑Res Equity",
        category: "non-residential",
        eligibility: u => (u.custType === "Non-Residential") && u.dacHftd === "yes",
        rate: u => RATES.smallResStep1,
        caps: { kWh: () => 2000 }
      },
      {
        name: "Non‑Residential Equity Resiliency",
        badge: "Non‑Res Resiliency",
        category: "non-residential",
        eligibility: u => (u.custType === "Non-Residential") && (u.pspsFlag === "yes" || u.criticalFacility !== "none"),
        rate: u => RATES.smallResStep1 + RATES.resiliencyAdderNonRes,
        caps: { kWh: () => 2000 }
      }
    ];

    const form = document.getElementById("calcForm");
    const resultsEl = document.getElementById("results");
    const errorEl = document.getElementById("error");

    form.addEventListener("submit", e => {
      e.preventDefault();
      errorEl.textContent = "";

      const user = {
        utility: document.getElementById("utility").value,
        zip: document.getElementById("zip").value,
        dacHftd: document.getElementById("dacHftd").value,
        custType: document.getElementById("custType").value,
        incomeFlag: document.getElementById("incomeFlag").value,
        pspsFlag: document.getElementById("pspsFlag").value,
        sjvTown: document.getElementById("sjvTown").value,
        criticalFacility: document.getElementById("criticalFacility").value,
        storageKWh: parseFloat(document.getElementById("storageKWh").value || 0),
        solarKW: parseFloat(document.getElementById("solarKW").value || 0),
        backupCapable: document.getElementById("backupCapable").value
      };

      if (!user.utility || !user.storageKWh) {
        errorEl.textContent = "Please complete required fields.";
        return;
      }

      let html = `<h2>Estimated Incentives for ${user.storageKWh} kWh Storage & ${user.solarKW} kW Solar</h2>`;
      html += `<table><thead><tr><th>Program</th><th>Eligible</th><th>Rate ($/Wh)</th><th>Est. Incentive</th></tr></thead><tbody>`;

      programs.forEach(p => {
        const eligible = p.eligibility(user);
        const rate = p.rate(user);
        const cap = p.caps.kWh();
        const kWhUsed = Math.min(user.storageKWh, cap);
        const storageAmt = kWhUsed * 1000 * rate;
        const solarAmt = user.solarKW ? user.solarKW * RATES.solarAdder * (p.name.includes("Solar") ? 1 : 0) : 0;
        const total = eligible ? storageAmt + solarAmt : 0;

        html += `<tr>
          <td><span class="badge">${p.badge}</span> ${p.name}</td>
          <td>${eligible ? "Yes" : "No"}</td>
          <td>$${rate.toFixed(2)}</td>
          <td>${eligible ? "$" + total.toLocaleString(undefined, {maximumFractionDigits:0}) : "–"}</td>
        </tr>`;
      });

      html += `</tbody></table>`;
      html += `<p class="help">Non‑residential storage & generation receive 50% upfront, 50% via performance‑based incentives (PBI).</p>`;
      html += `<p class="help">Results assume SGIP budget step 1 rates; actual reservation depends on remaining funds & step at time of application.</p>`;

      resultsEl.innerHTML = html;
      resultsEl.classList.add("show");
      resultsEl.scrollIntoView({behavior:"smooth"});
    });
  </script>
</body>
</html>
<!--
**a.** Want color‑blind friendly palette tweaks?
**b.** Embed AMI lookup API to auto‑check income eligibility next?
-->

