<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>SGIP Universal Eligibility & Rebate Calculator (Compact UX)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#ffba08;--secondary:#023e8a;--accent:#0077b6;--bg:#f8f9fa;--surface:#fff;--text:#212529;--muted:#666;
    }
    *{box-sizing:border-box;font-family:'Inter',Arial,sans-serif;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);}
    header{background:var(--secondary);color:#fff;padding:.75rem;text-align:center;}
    h1{font-size:clamp(1.25rem,2vw+1rem,1.75rem);font-weight:600;}
    #app{max-width:1000px;margin:auto;padding:1rem;}
    /* progress bar */
    .progress{display:flex;gap:.25rem;margin-bottom:1rem;}
    .progress div{flex:1;height:4px;background:#ced4da;border-radius:2px;transition:background .3s;}
    .progress .active{background:var(--primary);}
    /* wizard */
    .step{display:none;animation:fade .3s ease;max-height:72vh;overflow:auto;padding-right:.5rem;}
    .step.active{display:block;}
    @keyframes fade{from{opacity:.3}to{opacity:1}}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:1rem;}
    label{font-weight:600;font-size:.9rem;margin-bottom:.25rem;display:block;color:var(--secondary);}
    select,input{width:100%;padding:.55rem .6rem;border:1px solid #ced4da;border-radius:4px;font-size:.95rem;}
    .actions{display:flex;justify-content:space-between;margin-top:1rem;gap:.5rem;}
    button{border:none;border-radius:4px;padding:.65rem 1.25rem;font-weight:600;font-size:.95rem;cursor:pointer;transition:background .3s;}
    .next{background:var(--primary);} .back{background:#adb5bd;color:#fff;} .next:hover{background:var(--accent);color:#fff;} .back:hover{opacity:.85;}
    /* result */
    #result{background:var(--surface);padding:1rem;border-left:4px solid var(--primary);border-radius:4px;margin-top:1rem;display:none;line-height:1.5;}
    summary{cursor:pointer;font-weight:600;margin-bottom:.5rem;}
  </style>
</head>
<body>
<header><h1>SGIP Eligibility & Incentive Calculator</h1></header>
<div id="app">
  <!-- compact reference -->
  <details>
    <summary>📑 Quick-reference – current SGIP incentive rates</summary>
    <ul style="margin:.5rem 1.25rem;line-height:1.45">
      <li><strong>Equity Resiliency (Storage)</strong> – $1.00 / Wh fileciteturn3file3L107-L110</li>
      <li><strong>Residential Storage Equity</strong> – $0.85 / Wh fileciteturn3file3L99-L103</li>
      <li><strong>Residential Solar & Storage Equity</strong> – $1,100 / kWh (storage) & $3,100 / kW (solar) fileciteturn2file1L1-L8</li>
      <li><strong>Small Residential Storage (General Market)</strong> – Step-based $0.50 → $0.15 / Wh fileciteturn3file0L41-L55</li>
      <li><strong>Large-Scale Storage (General Market)</strong> – Step-based $0.50 → $0.25 / Wh fileciteturn3file0L57-L65</li>
      <li><strong>Renewable Generation Base</strong> – $2.00 / W with $2.50 / W resiliency adder fileciteturn3file3L127-L135</li>
    </ul>
  </details>

  <!-- progress bar -->
  <div class="progress" id="bar"></div>

  <form id="calcForm">
    <!-- STEP 1: Site Basics -->
    <section class="step active" data-step="0">
      <div class="grid">
        <div><label for="utility">Utility *</label>
          <select id="utility" required><option value="">--</option><option value="pge">PG&E</option><option value="sce">SCE</option><option value="sdge">SDG&E</option><option value="scg">SoCalGas</option></select></div>
        <div><label for="customerType">Customer Class *</label>
          <select id="customerType" required><option value="">--</option><option value="res-single">Residential Single-family</option><option value="res-multi">Residential Multifamily</option><option value="nonres">Non-Residential</option></select></div>
        <div><label for="step">Current SGIP Step *</label>
          <select id="step" required><option value="">--</option><option value="1">Step 1</option><option value="2">Step 2</option><option value="3">Step 3</option><option value="4">Step 4</option><option value="5">Step 5</option><option value="6">Step 6</option><option value="7">Step 7</option></select></div>
        <div><label for="storage">Battery Capacity (kWh)</label><input type="number" id="storage" min="0" step="0.1" placeholder="e.g. 15"/></div>
        <div><label for="pv">Solar Size (kW)</label><input type="number" id="pv" min="0" step="0.1" placeholder="e.g. 5"/></div>
      </div>
      <div class="actions"><span></span><button type="button" class="next">Next →</button></div>
    </section>

    <!-- STEP 2: Equity / Resiliency Flags -->
    <section class="step" data-step="1">
      <div class="grid">
        <div><label for="lowIncome">Low-Income Household?</label><select id="lowIncome"><option value="">--</option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="inDAC">Located in DAC?</label><select id="inDAC"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="inHFTD">Tier 2/3 HFTD?</label><select id="inHFTD"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="psps">2-plus PSPS events?</label><select id="psps"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="medical">Medical Baseline Resident?</label><select id="medical"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="waterWell">Electric Pump Well?</label><select id="waterWell"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
        <div><label for="critical">Critical Facility?</label><select id="critical"><option value=""></option><option value="yes">Yes</option><option value="no">No</option></select></div>
      </div>
      <div class="actions"><button type="button" class="back">← Back</button><button type="button" class="next">Next →</button></div>
    </section>

    <!-- STEP 3: Preview & Calculate -->
    <section class="step" data-step="2">
      <p>Please review your inputs and click <em>Calculate</em> to see eligibility and estimated incentives.</p>
      <div class="actions"><button type="button" class="back">← Back</button><button type="button" id="btnCalc" class="next">Calculate</button></div>
      <div id="result"></div>
    </section>
  </form>
</div>

<script>
const steps=[...document.querySelectorAll('.step')];
const bar=document.getElementById('bar');bar.innerHTML='<div></div>'.repeat(steps.length);
const bars=[...bar.children];bars[0].classList.add('active');
let cur=0;function show(i){steps[cur].classList.remove('active');bars[cur].classList.remove('active');cur=i;steps[cur].classList.add('active');bars[cur].classList.add('active');}
[...document.querySelectorAll('.next')].forEach(btn=>btn.onclick=()=>{if(cur<steps.length-1){show(cur+1);}});
[...document.querySelectorAll('.back')].forEach(btn=>btn.onclick=()=>{if(cur>0){show(cur-1);}});

/** Rate tables — pulled from SGIP Handbook **/
const STEP_RATES={1:{small:0.50,large:0.50},2:{small:0.40,large:0.40},3:{small:0.35,large:0.35},4:{small:0.30,large:0.30},5:{small:0.25,large:0.25},6:{small:0.20,large:null},7:{small:0.15,large:null}}; // $/Wh
const RATES={
  equityRes:1_000,              // $/Wh
  resStorageEquity:850,        // $/Wh
  rsseStorage:1_100,           // $/Wh
  rsseSolar:3_100,             // $/kW
  genBase:2_000,               // $/W
  genResAdder:2_500            // $/W
};

function val(id){return document.getElementById(id).value||'';}
function num(id){return parseFloat(val(id))||0;}
function yes(id){return val(id)==='yes';}

function determineProgram(){
  const cust=val('customerType');
  const low=yes('lowIncome');
  const dac=yes('inDAC');
  const hftd=yes('inHFTD');
  const psps=yes('psps');
  const medical=yes('medical');
  const well=yes('waterWell');
  const critical=yes('critical');

  // Equity Resiliency
  if((hftd||psps||medical||well||critical) && (low||dac))
    return 'Equity Resiliency';
  // Residential Storage Equity
  if(cust.startsWith('res') && (low||dac))
    return 'Residential Storage Equity';
  // RSSE (requires solar + storage present)
  if(cust.startsWith('res') && num('storage')>0 && num('pv')>0)
    return 'Residential Solar & Storage Equity';
  // General Market buckets
  if(cust==='res-single'||cust==='res-multi') return 'Small Residential Storage';
  return 'Large-Scale Storage';
}

function format(x){return x.toLocaleString(undefined,{maximumFractionDigits:0});}

document.getElementById('btnCalc').addEventListener('click',()=>{
  const prog=determineProgram();
  const batt=num('storage');const pv=num('pv');const step=parseInt(val('step'))||5;
  let msg=`<strong>Eligible Track:</strong> ${prog}`;
  let incentive=0;
  switch(prog){
    case 'Equity Resiliency':
      incentive=batt*RATES.equityRes;
      msg+=`<br>Storage incentive: $${format(incentive)} (@ $1.00/Wh)`;
      break;
    case 'Residential Storage Equity':
      incentive=batt*RATES.resStorageEquity;
      msg+=`<br>Storage incentive: $${format(incentive)} (@ $0.85/Wh)`;
      break;
    case 'Residential Solar & Storage Equity':
      const stor=batt*RATES.rsseStorage;
      const sol=pv*RATES.rsseSolar;
      incentive=stor+sol;
      msg+=`<br>Storage: $${format(stor)} + Solar: $${format(sol)} = <strong>$${format(incentive)}</strong>`;
      break;
    case 'Small Residential Storage':
      incentive=batt* (STEP_RATES[step]?.small||0);
      msg+=`<br>Storage incentive (Step ${step}): $${format(incentive)} (@ $${STEP_RATES[step]?.small||0}/Wh)`;
      break;
    case 'Large-Scale Storage':
      incentive=batt* (STEP_RATES[step]?.large||0);
      msg+=`<br>Storage incentive (Step ${step}): $${format(incentive)} (@ $${STEP_RATES[step]?.large||0}/Wh)`;
      break;
  }
  const res=document.getElementById('result');res.innerHTML=msg;res.style.display='block';show(2);
});
</script>
</body>
</html>
